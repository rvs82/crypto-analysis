<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <title>Crypto Trading</title>
    <style>
        body { font-family: 'Arial Narrow', Arial, sans-serif; margin: 20px; background-color: #f0f0f0; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 12px; }
        th { background-color: #4CAF50; color: white; }
        .long { color: green; }
        .short { color: red; }
        .neutral { color: black; }
        .market-flat { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: yellow; vertical-align: middle; margin-left: 4px; }
        .market-up { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: #90ee90; vertical-align: middle; margin-left: 4px; }
        .market-down { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: red; vertical-align: middle; margin-left: 4px; }
        .up { color: green; font-size: 14px; vertical-align: middle; margin-right: 4px; }
        .down { color: red; font-size: 14px; vertical-align: middle; margin-right: 4px; }
        .blink-green { animation: blinkGreen 2s infinite; }
        .blink-red { animation: blinkRed 2s infinite; }
        @keyframes blinkGreen {
            0% { background-color: white; }
            50% { background-color: rgba(0, 255, 0, 0.1); }
            100% { background-color: white; }
        }
        @keyframes blinkRed {
            0% { background-color: white; }
            50% { background-color: rgba(255, 0, 0, 0.1); }
            100% { background-color: white; }
        }
        #marketMood { width: 100%; height: 40px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; transition: background 1s ease; }
        #marketMood .longs { flex: 1; text-align: left; padding-left: 10px; }
        #marketMood .shorts { flex: 1; text-align: right; padding-right: 10px; }
        #tradeMain, #tradeTest { margin-top: 15px; font-size: 13px; border: 1px solid #ddd; padding: 8px; }
        #tradeMain strong, #tradeTest strong { font-weight: bold; }
        #reasoningMain, #reasoningTest { margin-top: 8px; font-size: 13px; }
        #statsMain, #statsTest { margin-top: 8px; font-size: 13px; border: 1px solid #ddd; padding: 8px; display: flex; align-items: center; }
        #marketReasoning { margin-top: 15px; font-size: 13px; border: 1px solid #ddd; padding: 8px; }
        #marketReasoning select { margin-right: 10px; font-size: 12px; padding: 2px; }
        details { margin-top: 5px; width: 100%; }
        summary { cursor: pointer; display: flex; align-items: center; }
        summary::marker { content: "Ў "; font-size: 10px; margin-right: 4px; }
        #forecastAI, #aiLog { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 12px; }
        #forecastAI details, #aiLog details { margin-bottom: 8px; }
        #forecastAI .block, #aiLog .block { border: 1px solid #ddd; padding: 5px; margin-bottom: 5px; }
        .tech-block { border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 11px; }
        h2 { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 14px; margin: 0 0 5px 0; }
        button { padding: 4px 8px; margin-left: 8px; background-color: #cccccc; border: none; cursor: pointer; font-size: 12px; }
        button:hover { background-color: #999999; }
        .new-learning { color: green; }
        .new-mistake { color: red; }
    </style>
</head>
<body>
    <div id="marketMood">
        <div class="longs">Лонги 0%</div>
        <div class="shorts">Шорты 0%</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Пара</th>
                <th>5м</th>
                <th>15м</th>
                <th>30м</th>
                <th>1ч</th>
                <th>4ч</th>
                <th>1д</th>
                <th>1н</th>
            </tr>
        </thead>
        <tbody id="data"></tbody>
    </table>
    <div id="tradeMain"><strong>Сделка:</strong> Нет</div>
    <div id="reasoningMain"></div>
    <div id="statsMain"><strong>Статистика:</strong> Загрузка... <button onclick="resetStatsMain()">Сбросить</button></div>
    <div id="tradeTest"><strong>Сделка (тест 5m):</strong> Нет</div>
    <div id="reasoningTest"></div>
    <div id="statsTest"><strong>Статистика (тест 5m):</strong> Загрузка... <button onclick="resetStatsTest()">Сбросить</button></div>
    <div id="marketReasoning">
        <strong>Рассуждения ИИ о рынке:</strong>
        <select id="currencySelect">
            <option value="all">Все валюты</option>
            <option value="LDOUSDT">LDOUSDT</option>
            <option value="AVAXUSDT">AVAXUSDT</option>
            <option value="AAVEUSDT">AAVEUSDT</option>
        </select>
        <select id="timeframeSelect">
            <option value="all">Все таймфреймы</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
            <option value="1w">1w</option>
        </select>
        <div id="reasoningText">Загрузка...</div>
    </div>
    <div id="forecastAI"><h2>Прогноз ИИ:</h2><br></div>
    <div id="aiLog"><h2>Лог ИИ:</h2><div class="block"><br></div></div>
    <details class="tech-block">
        <summary>Техническое задание</summary>
        <strong>Новый вариант (обновлено 26.03.2025):</strong><br>
        Сайт помогает трейдерам торговать криптовалютами (LDOUSDT, AVAXUSDT, AAVEUSDT), показывая прогнозы ИИ, статистику сделок и логи обучения ИИ. Дизайн минималистичный, функциональный, с акцентом на удобство и читаемость. Оптимизирован для бесплатного тарифа Render (512 МБ RAM, 0.1 CPU). Использует WebSocket Binance Futures для получения цен и свечей в реальном времени, обновление данных каждые 10 секунд с учётом UTC+3 (Москва). Логи планируется архивировать в Google Drive.<br><br>
        Дизайн и стили:<br>
        - Фон сайта: светло-серый (#F0F0F0).<br>
        - Таблица данных: белый (#FFFFFF) с границами светло-серого (#DDD).<br>
        - Заголовки таблицы: зелёный (#4CAF50), текст белый (#FFFFFF).<br>
        - Текст "Лонг": зелёный (#008000).<br>
        - Текст "Шорт": красный (#FF0000).<br>
        - Текст "Нет": чёрный (#000000).<br>
        - Квадратики рынка: Флет — жёлтый (#FFFF00), Восходящий — светло-зелёный (#90EE90), Нисходящий — красный (#FF0000), граница чёрная (#000000), размер 8x8px.<br>
        - Стрелки тренда: зелёная (#008000) для ^, красная (#FF0000) для v, размер 14px.<br>
        - Полоса настроения рынка: градиент от зелёного (#008000) слева до красного (#FF0000) справа, ширина 100%, высота 40px, текст белый (#FFFFFF).<br>
        - Выпадающие меню: фон белый (#FFFFFF), рамка 1px чёрная (#000000), текст чёрный (#000000).<br>
        - Кнопки "Сбросить": фон серый (#CCCCCC), текст чёрный (#000000), при наведении тёмно-серый (#999999).<br>
        - Шрифт: Arial Narrow; заголовки (h2) 14px полужирный, таблица/прогнозы/логи 12px, статистика/сделки/рассуждения 13px, техзадание 11px.<br>
        - Значки выпадающих меню: треугольник вниз (Ў), размер 10px, чёрный (#000000).<br>
        - Мигание ячеек: зелёное (от #FFFFFF до rgba(0, 255, 0, 0.1)) при пробое канала вверх (сигнал "Шорт"), красное (от #FFFFFF до rgba(255, 0, 0, 0.1)) при пробое вниз (сигнал "Лонг"), анимация 2 секунды, срабатывает только при outsideChannel и confidence >= 50%.<br><br>
        Структура и расположение блоков:<br>
        - Шапка: полоса настроения рынка (100% ширины, 40px высоты), текст "Лонги" слева (padding-left: 10px), "Шорты" справа (padding-right: 10px), выравнивание по центру по вертикали.<br>
        - Основной контент:<br>
          - Таблица данных (100% ширины, высота авто), текст центрирован, отступы 8px, в колонке "Пара" под названием валюты — актуальная цена с фиксированной шириной.<br>
          - "Сделка" (100% ширины, высота авто), текст слева, отступ сверху 15px, рамка 1px #ddd.<br>
          - "Рассуждения ИИ" для основной сделки (100% ширины, высота авто), текст слева, отступ сверху 8px.<br>
          - "Статистика" для основной сделки (100% ширины, высота авто), текст слева, кнопка "Сбросить" справа, отступ сверху 8px, рамка 1px #ddd.<br>
          - "Сделка (тест 5m)" (100% ширины, высота авто), текст слева, отступ сверху 15px, рамка 1px #ddd.<br>
          - "Рассуждения ИИ" для тестовой сделки (100% ширины, высота авто), текст слева, отступ сверху 8px.<br>
          - "Статистика (тест 5m)" (100% ширины, высота авто), текст слева, кнопка "Сбросить" справа, отступ сверху 8px, рамка 1px #ddd.<br>
          - "Рассуждения ИИ о рынке" (100% ширины, высота авто), текст слева, отступ сверху 15px, рамка 1px #ddd, с выбором валюты и таймфрейма через выпадающие списки.<br>
          - "Прогноз ИИ" (выпадающее меню, 100% ширины), текст слева, отступы внутри 5px, данные в блоках с рамкой 1px #ddd.<br>
          - "Лог ИИ" (блок с рамкой 1px #ddd под таблицей, 100% ширины), текст слева, отступы внутри 5px.<br>
        - Подвал:<br>
          - "Техническое задание" (блок с рамкой 1px #ddd, 100% ширины), текст слева, отступы внутри 8px, по умолчанию свёрнут.<br>
          - "Как работает сайт" (блок с рамкой 1px #ddd, 100% ширины), текст слева, отступы внутри 8px, по умолчанию свёрнут.<br>
          - Чекбокс "Звук" (слева, высота авто), отступ сверху 10px.<br><br>
        Функциональность:<br>
        - Таблица данных: показывает сигналы ("Лонг", "Шорт", "Нет"), % вероятности, квадратики рынка, стрелки тренда (обновляются раз в 5 свечей, не исчезают); обновляется каждые 10 секунд через WebSocket. В колонке "Пара" под названием валюты — актуальная цена.<br>
        - "Сделка": отображает текущую основную сделку (валюта, таймфрейм, направление, % вероятности, цены входа, стоп-лосса, профита), открывается только при пробое канала Nadaraya с уверенностью >=50%.<br>
          - "Сделка (тест 5m)": то же, но только для 5m-таймфрейма.<br>
        - "Рассуждения ИИ": текст о текущей сделке (условия, выводы), обновляется с новой сделкой.<br>
        - "Статистика": открытые/закрытые сделки, стопы, профиты, прибыль/убыток в USDT; кнопка "Сбросить" обнуляет всё.<br>
        - "Рассуждения ИИ о рынке": динамический анализ состояния рынка, настроений покупателей/продавцов, изменений тенденций, объёмов, волатильности, активности и рекомендаций, обновляется каждые 10 секунд. По умолчанию общий анализ, при выборе валюты и таймфрейма — специфический, шрифт 13px.<br>
        - "Прогноз ИИ": прогнозы по таймфреймам (рост/падение/стабильность, точка разворота, рассуждения в блоках с рамкой, включая границы боковика при консолидации), не сворачивается при обновлении.<br>
        - "Лог ИИ": 10 последних записей (дата в UTC+3, сделка, результат, анализ, выводы, действия) в блоке с рамкой под таблицей.<br>
        - Звук: колокольчик (5 секунд, https://freesound.org/data/previews/339/339810_5121236-lq.mp3) при пробое канала Nadaraya с уверенностью >=50%, управляется чекбоксом "Звук".<br><br>
        Требования к ИИ:<br>
        - Использует Nadaraya-Watson Envelope (Repainting Smoothing, bandwidth=8, multiplier=3, 500 свечей), синхронизировано с LuxAlgo на TradingView.<br>
        - EMA: периоды 50 и 200 для тренда и уровней, по закрытиям свечей.<br>
        - Учитывает: расстояние от границ канала, объёмы, EMA50/200, Фибоначчи (0.5, 0.618), BTC/ETH (снижает корреляцию при низкой зависимости), тренд (50 свечей), хвосты свечей, скачки, поглощения, реакцию рынка, баланс (50% покупатели/продавцы), уровни разворота, направление границ канала, частые выходы за границы, накопление объёмов, ретесты уровней, консолидацию (≥3 отскока, горизонтальность Nadaraya <0.5%).<br>
        - Прогнозы: обновляются каждые 10 секунд, стабильны, числа округляются до 0.0001, состояния на русском ("боковик", "вверх", "вниз", "бычье", "медвежье", "нет").<br>
        - Вероятность: зависит от факторов, усиливается при консолидации (+10% при совпадении Nadaraya и боковика).<br>
        - Обучение ИИ: онлайн, корректирует веса (+5% при прибыли, -5% при убытке). Низкая корреляция с BTC/ETH уменьшает их вес, накопление усиливает объёмы, консолидация усиливает вес боковика. Лог: 10 записей (дата UTC+3, сделка, результат, анализ, выводы, действия).<br><br>
        Причины функциональных элементов:<br>
        - Мигание ячеек: зелёное при пробое вверх (сигнал "Шорт"), красное при пробое вниз (сигнал "Лонг"), только при outsideChannel и confidence >=50%.<br>
        - Стрелки тренда: зелёная ^ при росте, красная v при падении, обновляются раз в 5 свечей, не исчезают.<br>
        - Квадратики рынка: жёлтый (Флет) — консолидация, зелёный (Восходящий) — пробой вверх, красный (Нисходящий) — пробой вниз.<br>
        - Процент вероятности: растёт при сильном сигнале (дальше от границы, больше объёмов, консолидация), падает при слабости.<br>
        - Прогноз "рост"/"падение": "рост" — пробой вверх, "падение" — пробой вниз, "стабильность" — консолидация.<br>
        - Обновление данных: каждые 10 секунд через WebSocket.<br>
        - Звук: колокольчик при пробое канала с уверенностью >=50%.<br>
        - Кнопка "Сбросить": обнуляет статистику.<br>
    </details>
    <details class="tech-block" id="howItWorks">
        <summary>Как работает сайт</summary>
        Этот сайт помогает трейдерам торговать криптовалютами (LDOUSDT, AVAXUSDT, AAVEUSDT), показывая сигналы и анализ рынка через ИИ. Вот как это работает:<br><br>
        Сайт использует индикатор Nadaraya-Watson Envelope (как LuxAlgo на TradingView: bandwidth=8, multiplier=3, 500 свечей) для определения диапазона цен. В режиме перерисовки (repainting) он строит канал, пробой верхней границы — сигнал "Шорт" (зелёное мигание ячейки), нижней — "Лонг" (красное мигание), срабатывает при confidence >=50%. Консолидация определяется ≥3 отскоками от уровней с горизонтальностью Nadaraya <0.5%, усиливает сигнал (+10% к confidence) при совпадении границ с боковиком. Сделки открываются только при пробое канала с уверенностью >=50%.<br><br>
        ИИ учитывает: расстояние от канала, объёмы, EMA (50 и 200, по закрытиям), Фибоначчи (0.5, 0.618), корреляцию с BTC/ETH, тренд (50 свечей), хвосты свечей, скачки, поглощения, реакцию рынка, баланс покупателей/продавцов, уровни разворота, накопление объёмов, ретесты. Сделки: 100 USDT, стоп-лосс 0.5%, тейк-профит 1%. Обучение: +5% веса при прибыли, -5% при убытке, корректировка весов для BTC/ETH, объёмов и консолидации.<br><br>
        Данные поступают через WebSocket Binance Futures (@ticker и @kline_5m), обновляются каждые 10 секунд (UTC+3). Таблица: сигналы, % вероятности, квадратики (Флет — жёлтый, Восходящий — зелёный, Нисходящий — красный), стрелки тренда (^/v, обновление раз в 5 свечей). Цены под парами в реальном времени. При пробое канала: звук (колокольчик, если включён), мигание ячеек (зелёное/красное). Под таблицей: сделки, статистика, прогнозы (с границами боковика), лог ИИ (10 записей). Оптимизировано для Render.<br><br>
        <strong>Чему научился ИИ:</strong><br>
        Пока нет данных<br><br>
        <strong>Ошибки ИИ:</strong><br>
        Пока нет данных
    </details>
    <div><input type="checkbox" id="channelExitCheckbox" checked> Звук</div>

    <script>
        const tbody = document.getElementById('data');
        const tradeMainDiv = document.getElementById('tradeMain');
        const reasoningMainDiv = document.getElementById('reasoningMain');
        const statsMainDiv = document.getElementById('statsMain');
        const tradeTestDiv = document.getElementById('tradeTest');
        const reasoningTestDiv = document.getElementById('reasoningTest');
        const statsTestDiv = document.getElementById('statsTest');
        const marketReasoningDiv = document.getElementById('marketReasoning');
        const currencySelect = document.getElementById('currencySelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const reasoningTextDiv = document.getElementById('reasoningText');
        const forecastAIDiv = document.getElementById('forecastAI');
        const aiLogDiv = document.getElementById('aiLog');
        const marketMood = document.getElementById('marketMood');
        let lastSignal = {};
        let trendUpdateCounter = {};
        let openDetails = {};
        let lastTrends = {};
        let lastData = null;

        function throttle(func, limit) {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        async function updateData() {
            try {
                const response = await fetch('/data', { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                console.log(`Получены данные в ${new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}:`, data);

                if (!data.recommendations || !data.tradesMain || !data.tradesTest || !data.prices) {
                    throw new Error('Некорректные данные от сервера');
                }

                lastData = data;
                renderUI(data);
            } catch (error) {
                console.error('Ошибка обработки данных:', error);
                tbody.innerHTML = '<tr><td colspan="8">Ошибка загрузки данных: ' + error.message + '</td></tr>';
                forecastAIDiv.innerHTML = '<h2>Прогноз ИИ:</h2> Ошибка загрузки: ' + error.message;
                aiLogDiv.innerHTML = '<h2>Лог ИИ:</h2><div class="block">Ошибка загрузки: ' + error.message + '</div>';
                reasoningTextDiv.innerHTML = 'Ошибка загрузки: ' + error.message;
            }
        }

        function renderUI(data) {
            tbody.innerHTML = '';
            let forecastHtml = '<h2>Прогноз ИИ:</h2><br>';
            let logHtml = '<h2>Лог ИИ:</h2><div class="block">';
            const symbols = ['LDOUSDT', 'AVAXUSDT', 'AAVEUSDT'];
            let totalLongs = 0;
            let totalShorts = 0;
            let totalCount = 0;

            for (const symbol of symbols) {
                const rec = data.recommendations[symbol] || {};
                const tradeMain = data.tradesMain[symbol] || { active: null, openCount: 0, closedCount: 0, stopCount: 0, profitCount: 0, totalProfit: 0, totalLoss: 0 };
                const tradeTest = data.tradesTest[symbol] || { active: null, openCount: 0, closedCount: 0, stopCount: 0, profitCount: 0, totalProfit: 0, totalLoss: 0 };
                const row = document.createElement('tr');

                trendUpdateCounter[symbol] = trendUpdateCounter[symbol] || {};
                lastTrends[symbol] = lastTrends[symbol] || {};
                forecastHtml += `<details ${openDetails[symbol] ? 'open' : ''}><summary>${symbol}</summary>`;

                row.innerHTML = `
                    <td style="width: 100px; white-space: nowrap;">${symbol}<br>${data.prices[symbol].toFixed(4)}</td>
                    ${TIMEFRAMES.map(tf => {
                        const r = rec[tf] || { direction: 'Нет', confidence: 0, market: 'Флет', trend: 'боковик', pivot: data.prices[symbol] || 0, reasoning: 'Нет данных', shortReasoning: 'Нет данных', forecast: 'падение', outsideChannel: false, touchesBoundary: false, isFlat: false };
                        const cls = r.direction === 'Лонг' ? 'long' : r.direction === 'Шорт' ? 'short' : 'neutral';
                        const marketCls = r.market === 'Флет' ? 'market-flat' : r.market === 'Восходящий' ? 'market-up' : 'market-down';
                        trendUpdateCounter[symbol][tf] = (trendUpdateCounter[symbol][tf] || 0) + 1;
                        const trendArrow = (trendUpdateCounter[symbol][tf] % 5 === 0 || !lastTrends[symbol][tf]) ? (r.trend === 'вверх' ? '^' : r.trend === 'вниз' ? 'v' : '^') : lastTrends[symbol][tf];
                        lastTrends[symbol][tf] = trendArrow;
                        const signalKey = `${symbol}-${tf}-${r.outsideChannel}`;
                        const blinkCls = r.outsideChannel && r.confidence >= 50 ? (r.direction === 'Шорт' ? 'blink-green' : 'blink-red') : '';
                        if (r.outsideChannel && lastSignal[signalKey] !== true && document.getElementById('channelExitCheckbox').checked && r.confidence >= 50) {
                            const audio = new Audio('https://freesound.org/data/previews/339/339810_5121236-lq.mp3');
                            audio.play().catch(() => console.log(`Колокольчик для ${symbol} не воспроизведён`));
                            lastSignal[signalKey] = true;
                        } else if (!r.outsideChannel) {
                            lastSignal[signalKey] = false;
                        }
                        forecastHtml += `<div class="block">${tf}: прогноз: <span class="${r.forecast === 'рост' ? 'up' : r.forecast === 'падение' ? 'down' : 'neutral'}">${r.forecast}</span>, ${r.shortReasoning}</div>`;
                        if (r.direction === 'Лонг') { totalLongs += r.confidence; totalCount++; }
                        else if (r.direction === 'Шорт') { totalShorts += r.confidence; totalCount++; }
                        return `<td class="${cls} ${blinkCls}"><span class="${marketCls}"></span> ${r.direction}${r.confidence > 0 ? ` ${Math.min(r.confidence, 100)}%` : ''} <span class="${r.trend === 'вверх' ? 'up' : 'down'}">${trendArrow}</span></td>`;
                    }).join('')}
                `;
                forecastHtml += `</details>`;
                tbody.appendChild(row);

                if (tradeMain.active) {
                    const cls = tradeMain.active.direction === 'Лонг' ? 'long' : 'short';
                    tradeMainDiv.innerHTML = `<strong>Сделка:</strong> ${symbol} (${tradeMain.active.timeframe}) <span class="${cls}">${tradeMain.active.direction}</span> (${rec[tradeMain.active.timeframe]?.confidence || 0}%), Открытие: ${tradeMain.active.entry.toFixed(4)}, Стоп: ${tradeMain.active.stopLoss.toFixed(4)}, Профит: ${tradeMain.active.takeProfit.toFixed(4)}`;
                    reasoningMainDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec[tradeMain.active.timeframe]?.reasoning || 'Нет данных'}`;
                } else {
                    tradeMainDiv.innerHTML = '<strong>Сделка:</strong> Нет';
                    reasoningMainDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec['5m']?.reasoning || 'Нет активных сделок. Возможные причины: цена не пробила уровни Nadaraya или недостаточная вероятность (>50%).'}`;
                }
                statsMainDiv.innerHTML = `<strong>Статистика:</strong> Открыто: ${tradeMain.openCount}, Закрыто: ${tradeMain.closedCount}, Стоп: ${tradeMain.stopCount}, Профит: ${tradeMain.profitCount}, Прибыль: ${tradeMain.totalProfit.toFixed(2)} USDT, Убыток: ${tradeMain.totalLoss.toFixed(2)} USDT <button onclick="resetStatsMain()">Сбросить</button>`;

                if (tradeTest.active) {
                    const cls = tradeTest.active.direction === 'Лонг' ? 'long' : 'short';
                    tradeTestDiv.innerHTML = `<strong>Сделка (тест 5m):</strong> ${symbol} (${tradeTest.active.timeframe}) <span class="${cls}">${tradeTest.active.direction}</span> (${rec[tradeTest.active.timeframe]?.confidence || 0}%), Открытие: ${tradeTest.active.entry.toFixed(4)}, Стоп: ${tradeTest.active.stopLoss.toFixed(4)}, Профит: ${tradeTest.active.takeProfit.toFixed(4)}`;
                    reasoningTestDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec[tradeTest.active.timeframe]?.reasoning || 'Нет данных'}`;
                } else {
                    tradeTestDiv.innerHTML = '<strong>Сделка (тест 5m):</strong> Нет';
                    reasoningTestDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec['5m']?.reasoning || 'Нет активных сделок. Возможные причины: цена не пробила уровни Nadaraya или недостаточная вероятность (>50%).'}`;
                }
                statsTestDiv.innerHTML = `<strong>Статистика (тест 5m):</strong> Открыто: ${tradeTest.openCount}, Закрыто: ${tradeTest.closedCount}, Стоп: ${tradeTest.stopCount}, Профит: ${tradeTest.profitCount}, Прибыль: ${tradeTest.totalProfit.toFixed(2)} USDT, Убыток: ${tradeTest.totalLoss.toFixed(2)} USDT <button onclick="resetStatsTest()">Сбросить</button>`;
            }

            const selectedCurrency = currencySelect.value;
            const selectedTimeframe = timeframeSelect.value;
            if (selectedCurrency === 'all' || selectedTimeframe === 'all') {
                reasoningTextDiv.innerHTML = data.marketOverview || 'Нет данных о рынке';
            } else {
                reasoningTextDiv.innerHTML = data.recommendations[selectedCurrency][selectedTimeframe]?.reasoning || 'Нет данных для выбранной валюты и таймфрейма';
            }

            const longPercent = totalCount > 0 ? Math.round(totalLongs / totalCount) : 0;
            const shortPercent = totalCount > 0 ? Math.round(totalShorts / totalCount) : 0;
            marketMood.style.background = `linear-gradient(to right, green ${longPercent}%, red ${longPercent}%)`;
            marketMood.querySelector('.longs').textContent = `Лонги ${longPercent}%`;
            marketMood.querySelector('.shorts').textContent = `Шорты ${shortPercent}%`;

            forecastAIDiv.innerHTML = forecastHtml || '<h2>Прогноз ИИ:</h2> Нет данных';
            logHtml += (data.aiLogs || []).map(log => `<p>${log}</p>`).join('') || 'Нет записей';
            logHtml += '</div>';
            aiLogDiv.innerHTML = logHtml;

            const howItWorks = document.getElementById('howItWorks');
            if (howItWorks) {
                const learnings = (data.aiLearnings || []).map((learn, i) => i === data.aiLearnings.length - 1 ? `<span class="new-learning">${learn}</span>` : learn).join('<br>');
                const mistakes = (data.aiMistakes || []).map((mistake, i) => i === data.aiMistakes.length - 1 ? `<span class="new-mistake">${mistake}</span>` : mistake).join('<br>');
                howItWorks.innerHTML = howItWorks.innerHTML.split('<strong>Чему научился ИИ:</strong>')[0] +
                    `<strong>Чему научился ИИ:</strong><br>${learnings || 'Пока нет данных'}<br><br>` +
                    `<strong>Ошибки ИИ:</strong><br>${mistakes || 'Пока нет данных'}`;
            }
        }

        function resetStatsMain() {
            fetch('/reset-stats-main', { method: 'POST' })
                .then(() => updateData())
                .catch(error => console.error('Ошибка сброса статистики (main):', error));
        }

        function resetStatsTest() {
            fetch('/reset-stats-test', { method: 'POST' })
                .then(() => updateData())
                .catch(error => console.error('Ошибка сброса статистики (test):', error));
        }

        document.addEventListener('click', (e) => {
            const summary = e.target.closest('summary');
            if (summary) {
                const symbol = summary.textContent.trim();
                openDetails[symbol] = !openDetails[symbol];
            }
        });

        const TIMEFRAMES = ['5m', '15m', '30m', '1h', '4h', '1d', '1w'];
        const throttledUpdate = throttle(updateData, 10000);

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM загружен, запускаем updateData');
            updateData();
            setInterval(throttledUpdate, 10000);
            currencySelect.addEventListener('change', updateData);
            timeframeSelect.addEventListener('change', updateData);
        });
    </script>
</body>
</html>
