<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Analysis</title>
    <style>
        body {
            background-color: #F0F0F0;
            font-family: 'Arial Narrow', Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .mood-bar {
            width: 100%;
            height: 40px;
            background: linear-gradient(to right, #008000, #FF0000);
            color: #FFFFFF;
            text-align: center;
            line-height: 40px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .timeframe-controls {
            margin: 10px 0;
        }
        .timeframe-controls label {
            margin-right: 10px;
            font-size: 14px;
        }
        .market-state, .market-reasoning, .deal-section, .forecast-section, .log-section, .suggestion-section, .footer {
            background-color: #FFFFFF;
            border: 1px solid #DDD;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .market-state h3, .market-reasoning h3, .deal-section h3, .forecast-section h3, .log-section h3, .suggestion-section h3, .footer h3 {
            font-size: 14px;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
        .market-state, .market-reasoning, .deal-comment, .stats {
            font-size: 13px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #FFFFFF;
            margin-bottom: 20px;
            border: 1px solid #DDD;
        }
        th, td {
            border: 1px solid #DDD;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }
        th {
            background-color: #4CAF50;
            color: #FFFFFF;
            font-weight: bold;
            font-size: 14px;
        }
        .pair-name {
            padding-right: 15px;
        }
        .pair-price {
            width: 100%;
            height: 100%;
            display: block;
        }
        .long { color: #008000; }
        .short { color: #FF0000; }
        .none { color: #000000; }
        .trend-flat { background-color: #FFFF00; width: 8px; height: 8px; border: 1px solid #000000; display: inline-block; }
        .trend-up { background-color: #90EE90; width: 8px; height: 8px; border: 1px solid #000000; display: inline-block; }
        .trend-down { background-color: #FF0000; width: 8px; height: 8px; border: 1px solid #000000; display: inline-block; }
        .arrow-up { color: #008000; font-size: 14px; }
        .arrow-down { color: #FF0000; font-size: 14px; }
        .reset-btn {
            background-color: #CCCCCC;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 13px;
        }
        .reset-btn:hover {
            background-color: #999999;
        }
        .forecast-section div {
            font-size: 12px;
            margin: 5px 0;
        }
        .forecast-growth { color: #008000; }
        .forecast-decline { color: #FF0000; }
        .forecast-stability { color: #000000; }
        .log-section, .suggestion-section {
            max-height: 200px;
            overflow-y: auto;
        }
        .footer {
            font-size: 11px;
        }
        .highlight-green {
            animation: fadeGreen 2s ease-in-out;
            background: rgba(0, 255, 0, 0.1);
        }
        .highlight-red {
            animation: fadeRed 2s ease-in-out;
            background: rgba(255, 0, 0, 0.1);
        }
        @keyframes fadeGreen {
            0% { background: rgba(0, 255, 0, 0); }
            50% { background: rgba(0, 255, 0, 0.1); }
            100% { background: rgba(0, 255, 0, 0); }
        }
        @keyframes fadeRed {
            0% { background: rgba(255, 0, 0, 0); }
            50% { background: rgba(255, 0, 0, 0.1); }
            100% { background: rgba(255, 0, 0, 0); }
        }
    </style>
</head>
<body>
    <div class="mood-bar" id="moodBar">Лонги: 0% Шорты: 0%</div>
    <div class="timeframe-controls">
        <label><input type="checkbox" value="5m" checked> 5м</label>
        <label><input type="checkbox" value="15m" checked> 15м</label>
        <label><input type="checkbox" value="30m"> 30м</label>
        <label><input type="checkbox" value="1h" checked> 1ч</label>
        <label><input type="checkbox" value="4h"> 4ч</label>
        <label><input type="checkbox" value="1d"> 1д</label>
        <label><input type="checkbox" value="1w"> 1н</label>
    </div>
    <div class="market-state" id="marketState"><h3>Состояние рынка</h3></div>
    <div class="market-reasoning" id="marketReasoning"><h3>Рассуждения ИИ о рынке</h3></div>
    <table>
        <thead>
            <tr>
                <th>Пара</th>
                <th>Цена</th>
                <th>5м</th>
                <th>15м</th>
                <th>30м</th>
                <th>1ч</th>
                <th>4ч</th>
                <th>1д</th>
                <th>1н</th>
            </tr>
        </thead>
        <tbody id="priceTable"></tbody>
    </table>
    <div class="deal-section" id="dealSection">
        <h3>Сделка</h3>
        <div id="dealMain">Нет</div>
        <div class="deal-comment" id="dealMainReasoning"></div>
        <div class="stats" id="statsMain"></div>
        <button class="reset-btn" onclick="resetStats('main')">Сбросить</button>
        <h3>Сделка (тест 5m/15m)</h3>
        <div id="dealTest">Нет</div>
        <div class="deal-comment" id="dealTestReasoning"></div>
        <div class="stats" id="statsTest"></div>
        <button class="reset-btn" onclick="resetStats('test')">Сбросить</button>
    </div>
    <div class="forecast-section" id="forecast"><h3>Прогноз ИИ</h3></div>
    <div class="log-section" id="aiLogs"><h3>Обучение ИИ</h3></div>
    <div class="suggestion-section" id="aiSuggestions"><h3>Предложения ИИ</h3></div>
    <div class="footer" id="footer">
        <h3>Техническое задание</h3>
        <p>Сайт помогает трейдерам торговать криптовалютами (LDOUSDT, AVAXUSDT, AAVEUSDT), показывая прогнозы ИИ, статистику сделок, логи и предложения ИИ. Дизайн минималистичный, функциональный, с акцентом на удобство и читаемость. Оптимизирован для Render (512 МБ RAM, 0.1 CPU). Использует WebSocket Binance Futures, обновление каждые 10 секунд (UTC+3).</p>
        <h3>Как работает сайт</h3>
        <p>Сайт помогает торговать LDOUSDT, AVAXUSDT, AAVEUSDT с помощью ИИ. Nadaraya-Watson (500 свечей) определяет канал: пробой вверх — "Шорт" (зелёное мигание ячейки), вниз — "Лонг" (красное мигание ячейки), только при outsideChannel. Квадратики: тренд ИИ (Флет — жёлтый, Восходящий — зелёный, Нисходящий — красный). Стрелки: к границе после пересечения (^ вверх после низа, v вниз после верха). Полоса настроения: % лонгов и шортов по прогнозу ИИ для таймфрейма (по умолчанию 1ч). Сделки (100 USDT): 1 основная, тестовые 5m/15m, confidence >=50%. Данные через WebSocket Binance Futures, обновление каждые 10 секунд (UTC+3). Индикатор нагрузки в подвале (% CPU).</p>
        <div>Звук <span id="loadIndicator">Нагрузка: 0%</span></div>
    </div>

    <script>
        let lastPrices = {};
        let aiLogs = [];

        function updateUI(data) {
            console.log('Полученные данные:', JSON.stringify(data));
            const moodBar = document.getElementById('moodBar');
            const marketState = document.getElementById('marketState');
            const marketReasoning = document.getElementById('marketReasoning');
            const priceTable = document.getElementById('priceTable');
            const dealMain = document.getElementById('dealMain');
            const dealMainReasoning = document.getElementById('dealMainReasoning');
            const statsMain = document.getElementById('statsMain');
            const dealTest = document.getElementById('dealTest');
            const dealTestReasoning = document.getElementById('dealTestReasoning');
            const statsTest = document.getElementById('statsTest');
            const forecast = document.getElementById('forecast');
            const aiLogsDiv = document.getElementById('aiLogs');
            const aiSuggestionsDiv = document.getElementById('aiSuggestions');
            const loadIndicator = document.getElementById('loadIndicator');

            // Проверка элементов
            console.log('Проверка элементов DOM:', { moodBar, marketState, marketReasoning, priceTable, dealMain, dealMainReasoning, statsMain, dealTest, dealTestReasoning, statsTest, forecast, aiLogsDiv, aiSuggestionsDiv, loadIndicator });

            console.log('Шаг 1: Обновление полосы настроения');
            const defaultTf = '1h';
            let totalLong = 0, totalShort = 0;
            Object.keys(data.recommendations || {}).forEach(symbol => {
                const rec = data.recommendations[symbol][defaultTf];
                if (rec && rec.direction === 'Long') totalLong += rec.confidence;
                if (rec && rec.direction === 'Short') totalShort += rec.confidence;
            });
            const longPercent = Math.round(totalLong / (Object.keys(data.recommendations || {}).length * 100) * 100) || 0;
            const shortPercent = Math.round(totalShort / (Object.keys(data.recommendations || {}).length * 100) * 100) || 0;
            moodBar.textContent = `Лонги: ${longPercent}% Шорты: ${shortPercent}%`;
            console.log('Полоса настроения обновлена:', moodBar.textContent);

            console.log('Шаг 2: Обновление состояния рынка');
            marketState.innerHTML = `<h3>Состояние рынка</h3>${data.marketOverview ? `Текущий рынок в целом показывает ${data.marketOverview.includes('sideways') ? 'боковой характер' : data.marketOverview.includes('uptrend') ? 'восходящий характер' : 'нисходящий характер'}. Средняя волатильность ${data.marketOverview.match(/Average volatility is (\d+\.\d+)/)?.[1] || 0}, указывает на ${data.marketOverview.includes('high activity') ? 'высокую активность' : 'спокойствие'}. Средние объёмы торгов ${data.marketOverview.match(/Average trading volumes are (\d+\.\d+)/)?.[1] || 0}, предполагают ${data.marketOverview.includes('buyers dominating') ? 'преобладание покупателей' : 'преобладание продавцов или баланс'}. Рекомендуется следить за ключевыми уровнями и ждать чётких сигналов пробоя для входа в сделки.` : 'Нет данных'}`;
            console.log('Состояние рынка обновлено:', marketState.innerHTML);

            console.log('Шаг 3: Обновление рассуждений ИИ');
            marketReasoning.innerHTML = `<h3>Рассуждения ИИ о рынке</h3>${data.recommendations?.['LDOUSDT']?.['5m']?.reasoning ? data.recommendations['LDOUSDT']['5m'].reasoning.replace('Market currently in Flat state', 'Рынок сейчас в боковом состоянии').replace('price', 'цена').replace('is inside channel', 'находится внутри канала').replace('Trend flat', 'Тренд боковой').replace('volumes rising', 'объёмы растут').replace('volumes stable', 'объёмы стабильны').replace('volumes falling', 'объёмы падают').replace('current volume', 'текущий объём').replace('vs average', 'против среднего').replace('volatility low', 'волатильность низкая').replace('buyers and sellers balanced', 'покупатели и продавцы в балансе').replace('sellers more active than buyers', 'продавцы активнее покупателей').replace('buyers more active than sellers', 'покупатели активнее продавцов').replace('candle wicks', 'хвосты свечей').replace('indicate high activity', 'указывают на высокую активность').replace('indicate medium activity', 'указывают на среднюю активность').replace('indicate low activity', 'указывают на низкую активность').replace('Resistance level', 'Уровень сопротивления').replace('and support', 'и поддержки').replace('limit movement', 'ограничивают движение').replace('Channel boundaries moving down', 'Границы канала движутся вниз').replace('Recommendation: wait for channel breakout for clear signal', 'Рекомендация: ждать пробоя канала для чёткого сигнала').replace('Spike', 'Скачок').replace('and engulfing none', 'и отсутствие поглощения') : 'Нет данных'}`;
            console.log('Рассуждения ИИ обновлены:', marketReasoning.innerHTML);

            console.log('Шаг 4: Обновление таблицы');
            priceTable.innerHTML = '';
            const symbols = ['LDOUSDT', 'AVAXUSDT', 'AAVEUSDT'];
            symbols.forEach(symbol => {
                console.log(`Обработка символа: ${symbol}`);
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = symbol;
                row.appendChild(nameCell);

                const priceCell = document.createElement('td');
                const newPrice = data.prices?.[symbol] || 0;
                priceCell.textContent = newPrice.toFixed(4);
                priceCell.className = 'pair-price';
                if (lastPrices[symbol] !== undefined) {
                    if (newPrice > lastPrices[symbol]) priceCell.classList.add('highlight-green');
                    else if (newPrice < lastPrices[symbol]) priceCell.classList.add('highlight-red');
                }
                lastPrices[symbol] = newPrice;
                row.appendChild(priceCell);

                const TIMEFRAMES = ['5m', '15m', '30m', '1h', '4h', '1d', '1w'];
                TIMEFRAMES.forEach(tf => {
                    console.log(`Обработка таймфрейма ${tf} для ${symbol}`);
                    const cell = document.createElement('td');
                    const rec = data.recommendations?.[symbol]?.[tf];
                    if (rec) {
                        const direction = rec.direction === 'Long' ? '<span class="long">Лонг</span>' : rec.direction === 'Short' ? '<span class="short">Шорт</span>' : '<span class="none">Нет</span>';
                        const confidence = rec.confidence || 0;
                        const trendClass = rec.trend === 'up' ? 'trend-up' : rec.trend === 'down' ? 'trend-down' : 'trend-flat';
                        const trendDirection = rec.trendDirection === 'up' ? '<span class="arrow-up">^</span>' : rec.trendDirection === 'down' ? '<span class="arrow-down">v</span>' : '';
                        cell.innerHTML = `${direction} ${confidence}% <span class="${trendClass}"></span> ${trendDirection}`;
                        if (rec.outsideChannel) {
                            cell.style.animation = rec.direction === 'Short' ? 'fadeGreen 2s' : 'fadeRed 2s';
                        }
                    } else {
                        cell.textContent = 'Нет данных';
                    }
                    row.appendChild(cell);
                });
                priceTable.appendChild(row);
            });
            console.log('Таблица обновлена:', priceTable.innerHTML);

            console.log('Шаг 5: Обновление сделок');
            const mainDeal = Object.values(data.tradesMain || {}).find(t => t.active) || { direction: 'Нет', reason: 'Нет активных сделок' };
            dealMain.textContent = mainDeal.direction;
            dealMainReasoning.textContent = `Комментарии: ${mainDeal.reason || 'Нет активных сделок'}`;
            statsMain.textContent = `Статистика: Открыто: ${data.tradesMain?.LDOUSDT?.openCount || 0}, Закрыто: ${data.tradesMain?.LDOUSDT?.closedCount || 0}, Стоп: ${data.tradesMain?.LDOUSDT?.stopCount || 0}, Профит: ${data.tradesMain?.LDOUSDT?.profitCount || 0}, Прибыль: ${(data.tradesMain?.LDOUSDT?.totalProfit || 0).toFixed(2)} USDT, Убыток: ${(data.tradesMain?.LDOUSDT?.totalLoss || 0).toFixed(2)} USDT`;
            console.log('Основная сделка обновлена:', dealMain.textContent, dealMainReasoning.textContent, statsMain.textContent);

            const testDeal = Object.values(data.tradesTest || {}).find(t => t['5m'] || t['15m']) || { direction: 'Нет', reason: 'Нет активных сделок. Причины: цена внутри канала, нет пробоя. Тренд боковой, объёмы падают, волатильность низкая.' };
            dealTest.textContent = testDeal['5m'] ? testDeal['5m'].direction : testDeal['15m'] ? testDeal['15m'].direction : 'Нет';
            dealTestReasoning.textContent = `Комментарии: ${testDeal['5m'] ? testDeal['5m'].reason : testDeal['15m'] ? testDeal['15m'].reason : 'Нет активных сделок. Причины: цена внутри канала, нет пробоя. Тренд боковой, объёмы падают, волатильность низкая.'}`;
            statsTest.textContent = `Статистика (тест 5m/15m): Открыто: ${data.tradesTest?.LDOUSDT?.openCount || 0}, Закрыто: ${data.tradesTest?.LDOUSDT?.closedCount || 0}, Стоп: ${data.tradesTest?.LDOUSDT?.stopCount || 0}, Профит: ${data.tradesTest?.LDOUSDT?.profitCount || 0}, Прибыль: ${(data.tradesTest?.LDOUSDT?.totalProfit || 0).toFixed(2)} USDT, Убыток: ${(data.tradesTest?.LDOUSDT?.totalLoss || 0).toFixed(2)} USDT`;
            console.log('Тестовая сделка обновлена:', dealTest.textContent, dealTestReasoning.textContent, statsTest.textContent);

            console.log('Шаг 6: Обновление прогноза ИИ');
            forecast.innerHTML = '<h3>Прогноз ИИ</h3>';
            Object.keys(data.recommendations || {}).forEach(symbol => {
                forecast.innerHTML += `<strong>${symbol}</strong><br>`;
                const TIMEFRAMES = ['5m', '15m', '30m', '1h', '4h', '1d', '1w'];
                TIMEFRAMES.forEach(tf => {
                    const rec = data.recommendations[symbol][tf];
                    if (rec) {
                        const volumeMatch = rec.shortReasoning?.match(/volume (-?\d+\.\d+)/)?.[1];
                        const volume = volumeMatch ? Math.abs(parseFloat(volumeMatch)) : 0;
                        forecast.innerHTML += `${tf}: <span class="${rec.forecast === 'growth' ? 'forecast-growth' : rec.forecast === 'decline' ? 'forecast-decline' : 'forecast-stability'}">прогноз: ${rec.forecast === 'growth' ? 'рост' : rec.forecast === 'decline' ? 'падение' : 'стабильность'}</span>, ${rec.shortReasoning ? rec.shortReasoning.replace('Trend flat', 'Тренд боковой').replace('Price', 'Цена').replace(/volume -?\d+\.\d+/, `объём ${volume}`).replace('inside', 'внутри') : 'Нет данных'}<br>`;
                    } else {
                        forecast.innerHTML += `${tf}: Нет данных<br>`;
                    }
                });
            });
            console.log('Прогноз ИИ обновлён:', forecast.innerHTML);

            console.log('Шаг 7: Обновление логов ИИ');
            aiLogs.push(`${new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}: Обновление данных для LDOUSDT, confidence = 0`);
            aiLogsDiv.innerHTML = '<h3>Обучение ИИ</h3>' + (aiLogs.length ? aiLogs.slice(-20).join('<br>') : 'Нет записей');
            console.log('Логи ИИ обновлены:', aiLogsDiv.innerHTML);

            console.log('Шаг 8: Обновление предложений ИИ');
            aiSuggestionsDiv.innerHTML = '<h3>Предложения ИИ</h3>' + (data.aiSuggestions?.length ? data.aiSuggestions.slice(-10).join('<br>') : 'Нет записей');
            console.log('Предложения ИИ обновлены:', aiSuggestionsDiv.innerHTML);

            console.log('Шаг 9: Обновление нагрузки');
            loadIndicator.textContent = `Нагрузка: ${data.serverLoad || 0}%`;
            console.log('Нагрузка обновлена:', loadIndicator.textContent);

            console.log('updateUI завершён');
        }

        function fetchData() {
            console.log('Запуск fetchData');
            fetch('/data')
                .then(response => {
                    console.log('Получен ответ от /data:', response.status);
                    if (!response.ok) throw new Error(`HTTP ошибка: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Данные успешно получены:', JSON.stringify(data));
                    updateUI(data);
                })
                .catch(error => {
                    console.error('Ошибка получения данных:', error);
                    document.getElementById('marketState').innerHTML = `<h3>Состояние рынка</h3>Ошибка загрузки данных: ${error.message}`;
                    document.getElementById('aiLogs').innerHTML = `<h3>Обучение ИИ</h3>Ошибка соединения с сервером: ${error.message}`;
                });
        }

        function resetStats(type) {
            console.log(`Сброс статистики для ${type}`);
            fetch(`/reset-stats-${type}`, { method: 'POST' })
                .then(() => {
                    console.log('Статистика сброшена, обновление данных');
                    fetchData();
                })
                .catch(error => console.error('Ошибка сброса статистики:', error));
        }

        console.log('Инициализация: запуск первого fetchData');
        fetchData();
        setInterval(() => {
            console.log('Запуск периодического обновления');
            fetchData();
        }, 10000);
    </script>
</body>
</html>
