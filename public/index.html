<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <title>Crypto Trading</title>
    <style>
        body { font-family: 'Arial Narrow', Arial, sans-serif; margin: 20px; background-color: #f0f0f0; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 12px; }
        th { background-color: #4CAF50; color: white; }
        .long { color: green; }
        .short { color: red; }
        .neutral { color: black; }
        .market-flat { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: yellow; vertical-align: middle; margin-left: 4px; }
        .market-up { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: #90ee90; vertical-align: middle; margin-left: 4px; }
        .market-down { display: inline-block; width: 8px; height: 8px; border: 1px solid black; background-color: red; vertical-align: middle; margin-left: 4px; }
        .up { color: green; font-size: 14px; vertical-align: middle; margin-right: 4px; }
        .down { color: red; font-size: 14px; vertical-align: middle; margin-right: 4px; }
        .blink-green { animation: blinkGreen 2s infinite; }
        .blink-red { animation: blinkRed 2s infinite; }
        @keyframes blinkGreen {
            0% { background-color: white; }
            50% { background-color: rgba(0, 255, 0, 0.1); }
            100% { background-color: white; }
        }
        @keyframes blinkRed {
            0% { background-color: white; }
            50% { background-color: rgba(255, 0, 0, 0.1); }
            100% { background-color: white; }
        }
        #marketMood { width: 100%; height: 40px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; transition: background 1s ease; }
        #marketMood .longs { flex: 1; text-align: left; padding-left: 10px; }
        #marketMood .shorts { flex: 1; text-align: right; padding-right: 10px; }
        #tradeMain, #tradeTest { margin-top: 15px; font-size: 13px; border: 1px solid #ddd; padding: 8px; }
        #tradeMain strong, #tradeTest strong { font-weight: bold; }
        #reasoningMain, #reasoningTest { margin-top: 8px; font-size: 13px; }
        #statsMain, #statsTest { margin-top: 8px; font-size: 13px; border: 1px solid #ddd; padding: 8px; display: flex; align-items: center; }
        details { margin-top: 5px; width: 100%; }
        summary { cursor: pointer; display: flex; align-items: center; }
        summary::marker { content: "▼ "; font-size: 10px; margin-right: 4px; }
        #forecastAI, #aiLog { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 12px; }
        #forecastAI details, #aiLog details { margin-bottom: 8px; }
        #forecastAI .block, #aiLog .block { border: 1px solid #ddd; padding: 5px; margin-bottom: 5px; }
        .tech-block { border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 11px; }
        h2 { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 14px; margin: 0 0 5px 0; }
        button { padding: 4px 8px; margin-left: 8px; background-color: #cccccc; border: none; cursor: pointer; font-size: 12px; }
        button:hover { background-color: #999999; }
        .new-learning { color: green; }
        .new-mistake { color: red; }
    </style>
</head>
<body>
    <div id="marketMood">
        <div class="longs">Лонги 0%</div>
        <div class="shorts">Шорты 0%</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Пара</th>
                <th>5м</th>
                <th>15м</th>
                <th>30м</th>
                <th>1ч</th>
                <th>4ч</th>
                <th>1д</th>
                <th>1н</th>
            </tr>
        </thead>
        <tbody id="data"></tbody>
    </table>
    <div id="tradeMain"><strong>Сделка:</strong> Нет</div>
    <div id="reasoningMain"></div>
    <div id="statsMain"><strong>Статистика:</strong> Загрузка... <button onclick="resetStatsMain()">Сбросить</button></div>
    <div id="tradeTest"><strong>Сделка (тест 5m):</strong> Нет</div>
    <div id="reasoningTest"></div>
    <div id="statsTest"><strong>Статистика (тест 5m):</strong> Загрузка... <button onclick="resetStatsTest()">Сбросить</button></div>
    <div id="forecastAI"><h2>Прогноз ИИ:</h2><br></div>
    <div id="aiLog"><h2>Лог ИИ:</h2><div class="block"><br></div></div>
    <div class="tech-block">
        <h2>Техническое задание</h2>
        <strong>Новый вариант (обновлено):</strong><br>
        Сайт помогает трейдерам торговать криптовалютами (LDOUSDT, AVAXUSDT, AAVEUSDT), показывая прогнозы ИИ, статистику сделок, логи обучения ИИ и архив логов для скачивания. Дизайн минималистичный, функциональный, с акцентом на удобство и читаемость. Сайт оптимизирован для бесплатного тарифа Render (512 МБ RAM, 0.1 CPU), использует Google Drive для хранения архива логов.<br><br>
        Дизайн и стили:<br>
        - Фон сайта: светло-серый (#F0F0F0).<br>
        - Таблица данных: белый (#FFFFFF) с границами светло-серого (#DDD).<br>
        - Заголовки таблицы: зелёный (#4CAF50), текст белый (#FFFFFF).<br>
        - Текст "Лонг": зелёный (#008000).<br>
        - Текст "Шорт": красный (#FF0000).<br>
        - Текст "Нет": чёрный (#000000).<br>
        - Квадратики рынка: Флет — жёлтый (#FFFF00), Восходящий — светло-зелёный (#90EE90), Нисходящий — красный (#FF0000), граница чёрная (#000000), размер 8x8px.<br>
        - Стрелки тренда: зелёная (#008000) для ↑, красная (#FF0000) для ↓, размер 14px.<br>
        - Полоса настроения рынка: градиент от зелёного (#008000) слева до красного (#FF0000) справа, ширина 100%, высота 40px, текст белый (#FFFFFF).<br>
        - Выпадающие меню: фон белый (#FFFFFF), рамка 1px чёрная (#000000), текст чёрный (#000000).<br>
        - Кнопки "Сбросить": фон серый (#CCCCCC), текст чёрный (#000000), при наведении тёмно-серый (#999999).<br>
        - Шрифт: Arial Narrow, без засечек; заголовки (h2) 14px полужирный, таблица/прогнозы/логи 12px, статистика/сделки 13px, техзадание 11px.<br>
        - Значки выпадающих меню: треугольник вниз (▼), размер 10px, чёрный (#000000), в одной строке с названием через CSS display: inline.<br>
        - Мигание ячеек: зелёное (от #FFFFFF до rgba(0, 255, 0, 0.1)), красное (от #FFFFFF до rgba(255, 0, 0, 0.1)), анимация 2 секунды.<br><br>
        Структура и расположение блоков:<br>
        - Шапка: полоса настроения рынка (100% ширины, 40px высоты), текст "Лонги" слева (padding-left: 10px), "Шорты" справа (padding-right: 10px), выравнивание по центру по вертикали.<br>
        - Основной контент:<br>
          - Таблица данных (100% ширины, высота авто), текст центрирован, отступы 8px.<br>
          - "Сделка" (100% ширины, высота авто), текст слева, отступ сверху 15px, рамка 1px #ddd.<br>
          - "Рассуждения ИИ" для основной сделки (100% ширины, высота авто), текст слева, отступ сверху 8px.<br>
          - "Статистика" для основной сделки (100% ширины, высота авто), текст слева, кнопка "Сбросить" справа, отступ сверху 8px, рамка 1px #ddd.<br>
          - "Сделка (тест 5m)" (100% ширины, высота авто), текст слева, отступ сверху 15px, рамка 1px #ddd.<br>
          - "Рассуждения ИИ" для тестовой сделки (100% ширины, высота авто), текст слева, отступ сверху 8px.<br>
          - "Статистика (тест 5m)" (100% ширины, высота авто), текст слева, кнопка "Сбросить" справа, отступ сверху 8px, рамка 1px #ddd.<br>
          - "Прогноз ИИ" (выпадающее меню, 100% ширины), текст слева, отступы внутри 5px, данные в блоках с рамкой 1px #ddd.<br>
          - "Лог ИИ" (блок с рамкой 1px #ddd под таблицей, 100% ширины), текст слева, отступы внутри 5px.<br>
        - Подвал:<br>
          - "Техническое задание" (блок с рамкой 1px #ddd, 100% ширины), текст слева, отступы внутри 8px.<br>
          - "Как работает сайт" (блок с рамкой 1px #ddd, 100% ширины), текст слева, отступы внутри 8px.<br>
          - Чекбокс "Звук" (слева, высота авто), отступ сверху 10px.<br><br>
        Функциональность:<br>
        - Таблица данных: показывает сигналы ("Лонг", "Шорт", "Нет"), % вероятности, квадратики рынка, стрелки тренда (не исчезают, только обновляют направление); обновляется каждые 10 секунд.<br>
        - "Сделка": отображает текущую основную сделку (валюта, таймфрейм, направление, % вероятности, цены входа, стоп-лосса, профита), обновляется при изменении.<br>
          - "Сделка (тест 5m)": то же, но только для 5m-таймфрейма.<br>
        - "Рассуждения ИИ": текст о текущей сделке (условия, выводы), обновляется с новой сделкой.<br>
        - "Статистика": открытые/закрытые сделки, стопы, профиты, прибыль/убыток в USDT; кнопка "Сбросить" обнуляет всё.<br>
        - "Прогноз ИИ": прогнозы по таймфреймам (рост/падение, точка разворота, рассуждения в блоках с рамкой), не сворачивается при обновлении.<br>
        - "Лог ИИ": 10 последних записей (дата, сделка, результат, анализ, выводы, действия) в блоке с рамкой под таблицей.<br>
        - Звук: колокольчик (5 секунд, https://freesound.org/data/previews/339/339810_5121236-lq.mp3) при выходе за канал, управляется чекбоксом "Звук".<br><br>
        Требования к ИИ:<br>
        - Использует Nadaraya-Watson Envelope (Repainting Smoothing, bandwidth=8, multiplier=3, limit=1000 свечей) для прогнозов ("рост"/"падение") и % вероятности.<br>
        - EMA: периоды 50 и 200 для определения тренда и уровней поддержки/сопротивления.<br>
        - Учитывает: расстояние от границ канала, объёмы, EMA50/200, Фибоначчи (0.5, 0.618), BTC/ETH (снижает корреляцию при низкой зависимости), тренд (50 свечей), хвосты свечей, скачки, поглощения, реакцию рынка, баланс (50% покупатели/продавцы), уровни разворота, направление границ канала, частые выходы за границы без возврата к середине, накопление (рост объёмов в узком диапазоне как сигнал разворота или продолжения), ретесты уровней с ликвидностью (снятие минимумов/максимумов).<br>
        - Прогнозы: обновляются каждые 10 секунд, стабильны, без резких смен, числа округляются до 0.0001, тренд и состояния на русском ("боковик", "вверх", "вниз", "бычье", "медвежье", "нет").<br>
        - Вероятность успешности: зависит от всех факторов, цены без скобок, OBV заменён на "объём".<br>
        - Обучение ИИ: онлайн, корректирует веса факторов (+5% при прибыли, -5% при убытке) после каждой сделки. При низкой корреляции с BTC/ETH уменьшает их вес. Накопление усиливает вес объёмов. Ведёт лог в "Лог ИИ" (10 записей): дата, сделка, результат, анализ, выводы, действия. Логи архивируются в Google Drive (`ai_log_archive.json`) без лимита.<br><br>
        Причины функциональных элементов:<br>
        - Мигание ячеек: зелёное при выходе за верхнюю границу — сигнал "Шорта" (цена может упасть), красное при выходе за нижнюю — сигнал "Лонга" (цена может вырасти). Нет мигания внутри канала — нет сигнала.<br>
        - Стрелки тренда: зелёная ↑ при касании нижней границы и росте — бычий сигнал, красная ↓ при касании верхней и падении — медвежий сигнал. Обновляются раз в 5 свечей, не исчезают.<br>
        - Квадратики рынка: жёлтый (Флет) — цена в канале, рынок спокоен; зелёный (Восходящий) — выход вверх, покупатели сильны; красный (Нисходящий) — выход вниз, продавцы активны.<br>
        - Процент вероятности: растёт при сильном сигнале (дальше от границы, больше объёмов, тренд, Фибоначчи), падает при слабости (равновесие рынка, ошибки).<br>
        - Прогноз "рост"/"падение": "рост" — цена ниже нижней границы, объёмы растут, тренд вверх; "падение" — цена выше верхней, объёмы падают, тренд вниз.<br>
        - Обновление данных: каждые 10 секунд для актуальности без перегрузки Render.<br>
        - Звук: колокольчик при выходе за канал, чтобы не пропустить сигнал.<br>
        - Кнопка "Сбросить": обнуляет все сделки для нового старта.<br>
    </div>
    <div class="tech-block">
        <h2>Как работает сайт</h2>
        Этот сайт помогает трейдерам решать, покупать или продавать криптовалюты (LDOUSDT, AVAXUSDT, AAVEUSDT), показывая сигналы для сделок и анализируя рынок. Вот как это работает:<br><br>
        Сайт использует индикатор Nadaraya-Watson Envelope — это рамка вокруг цены, показывающая, где она обычно находится. У рамки есть верхняя граница, нижняя граница и середина. Если цена уходит выше верхней границы примерно на 0.5%, это сигнал "Шорт" (продажа), потому что она может вернуться к середине. Если ниже нижней — "Лонг" (покупка), так как цена может пойти вверх. Но 0.5% — это не строго, ИИ смотрит по ситуации. Он проверяет, чтобы это был настоящий пробой, а не топтание у границы (накопление). Накопление — это рост объёмов в узком диапазоне, что может быть сигналом разворота или продолжения тренда. Для этого ИИ смотрит объёмы: если они растут — больше покупателей, значит "Лонг", если падают — больше продавцов, значит "Шорт". Также он учитывает уровни EMA (50 и 200) — это как стены, от которых цена может отскочить, уровни Фибоначчи (0.5 и 0.618) — точки, куда цена часто приходит, и поглощение свечи — когда новая свеча перекрывает старую, показывая силу покупателей или продавцов. ИИ смотрит ретесты уровней (снятие ликвидности с прошлых минимумов/максимумов) как сигнал продолжения или разворота. ИИ проверяет движение BTC и ETH: если LDO пробила границу, а BTC ещё нет, LDO может идти дальше, пока BTC не отскочит, но при низкой корреляции уменьшает их влияние. Длинные хвосты на свечах показывают интерес покупателей или продавцов — это тоже сигнал.<br><br>
        ИИ выбирает одну сделку с вероятностью успеха 50% или больше. Он считает вероятность, глядя на пробой границы, объёмы, EMA, Фибоначчи, поглощение, ретесты и движение BTC с ETH (если корреляция низкая, их вес меньше). Сделка открывается только при пробое: выше верхней — "Шорт", ниже нижней — "Лонг". Размер сделки — 100 USDT. ИИ ставит стоп-лосс и тейк-профит, они не меняются до закрытия. Сделка закрывается, если цена доходит до стоп-лосса (убыток) или тейк-профита (прибыль). В боковике (Флет, жёлтый квадратик) ИИ торгует от границ к середине, в росте (Восходящий, зелёный) чаще выбирает "Лонг", в падении (Нисходящий, красный) — "Шорт". Если цена часто выходит за одну границу и не идёт к середине, ИИ видит сильный тренд и доверяет ему больше. Накопление усиливает сигнал объёмов. ИИ учится: если сделка убыточна, он осторожнее, при низкой корреляции с BTC/ETH снижает их вес.<br><br>
        Данные о ценах и объёмах берутся с Binance в реальном времени. Каждые 10 секунд сайт обновляет цены и сигналы. ИИ смотрит последние 1000 свечей для каждой валюты и таймфрейма (5м, 15м, 30м, 1ч, 4ч, 1д, 1н). Он считает границы Nadaraya, проверяет объёмы, EMA, Фибоначчи, поглощение, корреляцию с BTC и ETH, хвосты свечей, ретесты уровней. ИИ ждёт чёткого пробоя, смотрит, чтобы не было топтания, и учитывает BTC и ETH с учётом корреляции. Всё делает ИИ автоматически по правилам, человек не вмешивается. ИИ учится на ошибках, чтобы их не повторять.<br><br>
        Вверху — блок настроения рынка: "Лонги" (зелёный % слева) и "Шорты" (красный % справа) с плавным градиентом, данные из прогнозов ИИ. В таблице для каждого таймфрейма: сигнал ("Лонг", "Шорт", "Нет"), вероятность (например, 70%), квадратик рынка (жёлтый — Флет, зелёный — Восходящий, красный — Нисходящий) слева, стрелка (↑ зелёная, ↓ красная) справа — куда идёт цена от последней границы, не исчезает, только обновляется. Квадратики и стрелки обновляются раз в 5 свечей. Если цена пробивает верхнюю границу, ячейка мигает слабым зелёным, нижнюю — слабым красным, пока не вернётся в рамку, звучит колокольчик (5 секунд, разово). Под таблицей — сделка в рамке, её параметры и объяснение ИИ, статистика в двух рамках, лог ИИ в рамке, прогноз ИИ для каждой валюты в меню с рамками, техзадание и "Как работает сайт" в блоках с рамкой. Внизу — чекбокс звука. Сайт оптимизирован для Render и работает плавно.<br><br>
        <strong>Чему научился ИИ:</strong><br>
        Здесь ИИ записывает, что он понял за всё время работы. Новые данные добавляются зелёным цветом.<br>
        Пока нет данных<br><br>
        <strong>Ошибки ИИ:</strong><br>
        Здесь ИИ записывает свои промахи. Новые данные добавляются красным цветом.<br>
        Пока нет данных
    </div>
    <div><input type="checkbox" id="channelExitCheckbox" checked> Звук</div>

    <script>
        const tbody = document.getElementById('data');
        const tradeMainDiv = document.getElementById('tradeMain');
        const reasoningMainDiv = document.getElementById('reasoningMain');
        const statsMainDiv = document.getElementById('statsMain');
        const tradeTestDiv = document.getElementById('tradeTest');
        const reasoningTestDiv = document.getElementById('reasoningTest');
        const statsTestDiv = document.getElementById('statsTest');
        const forecastAIDiv = document.getElementById('forecastAI');
        const aiLogDiv = document.getElementById('aiLog');
        const marketMood = document.getElementById('marketMood');
        let lastSignal = {};
        let trendUpdateCounter = {};
        let openDetails = {};
        let lastTrends = {};

        function updateData() {
            fetch('/data')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    tbody.innerHTML = '';
                    let forecastHtml = '<h2>Прогноз ИИ:</h2><br>';
                    let logHtml = '<h2>Лог ИИ:</h2><div class="block">';
                    const symbols = ['LDOUSDT', 'AVAXUSDT', 'AAVEUSDT'];
                    let totalLongs = 0;
                    let totalShorts = 0;
                    let totalCount = 0;

                    for (const symbol of symbols) {
                        const rec = data.recommendations[symbol] || {};
                        const tradeMain = data.tradesMain[symbol] || { active: null, openCount: 0, closedCount: 0, stopCount: 0, profitCount: 0, totalProfit: 0, totalLoss: 0 };
                        const tradeTest = data.tradesTest[symbol] || { active: null, openCount: 0, closedCount: 0, stopCount: 0, profitCount: 0, totalProfit: 0, totalLoss: 0 };
                        const row = document.createElement('tr');
                        trendUpdateCounter[symbol] = trendUpdateCounter[symbol] || {};
                        lastTrends[symbol] = lastTrends[symbol] || {};
                        forecastHtml += `<details ${openDetails[symbol] ? 'open' : ''}><summary>${symbol}</summary>`;

                        row.innerHTML = `
                            <td>${symbol}</td>
                            ${TIMEFRAMES.map(tf => {
                                const r = rec[tf] || { direction: 'Нет', confidence: 0, market: 'Флет', trend: 'боковик', pivot: lastPrices[symbol], reasoning: 'Нет данных', forecast: 'падение', outsideChannel: false };
                                const cls = r.direction === 'Лонг' ? 'long' : r.direction === 'Шорт' ? 'short' : 'neutral';
                                const marketCls = r.market === 'Флет' ? 'market-flat' : r.market === 'Восходящий' ? 'market-up' : 'market-down';
                                trendUpdateCounter[symbol][tf] = (trendUpdateCounter[symbol][tf] || 0) + 1;
                                const trendArrow = (trendUpdateCounter[symbol][tf] % 5 === 0 || !lastTrends[symbol][tf]) ? (r.trend === 'вверх' ? '↑' : r.trend === 'вниз' ? '↓' : '↑') : lastTrends[symbol][tf];
                                lastTrends[symbol][tf] = trendArrow;
                                const blinkCls = r.outsideChannel ? (r.direction === 'Шорт' ? 'blink-green' : 'blink-red') : '';
                                const signalKey = `${symbol}-${tf}-${r.outsideChannel}`;
                                if (r.outsideChannel && lastSignal[signalKey] !== true && document.getElementById('channelExitCheckbox').checked) {
                                    const audio = new Audio('https://freesound.org/data/previews/339/339810_5121236-lq.mp3');
                                    audio.play().catch(() => console.log(`Колокольчик для ${symbol} не воспроизведён`));
                                    lastSignal[signalKey] = true;
                                } else if (!r.outsideChannel) {
                                    lastSignal[signalKey] = false;
                                }
                                forecastHtml += `<div class="block">${tf}: прогноз: <span class="${r.forecast === 'рост' ? 'up' : 'down'}">${r.forecast}</span>, ${r.reasoning}</div>`;
                                if (r.direction === 'Лонг') {
                                    totalLongs += r.confidence;
                                    totalCount++;
                                } else if (r.direction === 'Шорт') {
                                    totalShorts += r.confidence;
                                    totalCount++;
                                }
                                return `<td class="${cls} ${blinkCls}"><span class="${marketCls}"></span> ${r.direction}${r.confidence > 0 ? ` ${Math.min(r.confidence, 100)}%` : ''} <span class="${r.trend === 'вверх' ? 'up' : 'down'}">${trendArrow}</span></td>`;
                            }).join('')}
                        `;
                        forecastHtml += `</details>`;
                        tbody.appendChild(row);

                        if (tradeMain.active) {
                            const cls = tradeMain.active.direction === 'Лонг' ? 'long' : 'short';
                            tradeMainDiv.innerHTML = `<strong>Сделка:</strong> ${symbol} (${tradeMain.active.timeframe}) <span class="${cls}">${tradeMain.active.direction}</span> (${rec[tradeMain.active.timeframe]?.confidence || 0}%), Открытие: ${tradeMain.active.entry.toFixed(4)}, Стоп: ${tradeMain.active.stopLoss.toFixed(4)}, Профит: ${tradeMain.active.takeProfit.toFixed(4)}`;
                            reasoningMainDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec[tradeMain.active.timeframe]?.reasoning || 'Нет данных'}`;
                        } else {
                            tradeMainDiv.innerHTML = '<strong>Сделка:</strong> Нет';
                            reasoningMainDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> Нет активных сделок. Возможные причины: цена не пробила уровни Nadaraya, недостаточная вероятность (>50%), или рынок в консолидации.`;
                        }
                        statsMainDiv.innerHTML = `<strong>Статистика:</strong> Открыто: ${tradeMain.openCount}, Закрыто: ${tradeMain.closedCount}, Стоп: ${tradeMain.stopCount}, Профит: ${tradeMain.profitCount}, Прибыль: ${tradeMain.totalProfit.toFixed(2)} USDT, Убыток: ${tradeMain.totalLoss.toFixed(2)} USDT <button onclick="resetStatsMain()">Сбросить</button>`;

                        if (tradeTest.active) {
                            const cls = tradeTest.active.direction === 'Лонг' ? 'long' : 'short';
                            tradeTestDiv.innerHTML = `<strong>Сделка (тест 5m):</strong> ${symbol} (${tradeTest.active.timeframe}) <span class="${cls}">${tradeTest.active.direction}</span> (${rec[tradeTest.active.timeframe]?.confidence || 0}%), Открытие: ${tradeTest.active.entry.toFixed(4)}, Стоп: ${tradeTest.active.stopLoss.toFixed(4)}, Профит: ${tradeTest.active.takeProfit.toFixed(4)}`;
                            reasoningTestDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec[tradeTest.active.timeframe]?.reasoning || 'Нет данных'}`;
                        } else {
                            tradeTestDiv.innerHTML = '<strong>Сделка (тест 5m):</strong> Нет';
                            reasoningTestDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> Нет активных сделок. Возможные причины: цена не пробила уровни Nadaraya, недостаточная вероятность (>50%), или рынок в консолидации.`;
                        }
                        statsTestDiv.innerHTML = `<strong>Статистика (тест 5m):</strong> Открыто: ${tradeTest.openCount}, Закрыто: ${tradeTest.closedCount}, Стоп: ${tradeTest.stopCount}, Профит: ${tradeTest.profitCount}, Прибыль: ${tradeTest.totalProfit.toFixed(2)} USDT, Убыток: ${tradeTest.totalLoss.toFixed(2)} USDT <button onclick="resetStatsTest()">Сбросить</button>`;
                    }

                    const longPercent = totalCount > 0 ? Math.round(totalLongs / (totalCount * 100) * 100) : 0;
                    const shortPercent = totalCount > 0 ? Math.round(totalShorts / (totalCount * 100) * 100) : 0;
                    marketMood.style.background = `linear-gradient(to right, green ${longPercent}%, red ${longPercent}%)`;
                    marketMood.querySelector('.longs').textContent = `Лонги ${longPercent}%`;
                    marketMood.querySelector('.shorts').textContent = `Шорты ${shortPercent}%`;

                    forecastAIDiv.innerHTML = forecastHtml || '<h2>Прогноз ИИ:</h2> Нет данных';
                    logHtml += data.aiLogs.map(log => `<p>${log}</p>`).join('') || 'Нет записей';
                    logHtml += '</div>';
                    aiLogDiv.innerHTML = logHtml;

                    const howItWorks = document.getElementById('howItWorks');
                    const learnings = data.aiLearnings.map((learn, i) => i === data.aiLearnings.length - 1 ? `<span class="new-learning">${learn}</span>` : learn).join('<br>');
                    const mistakes = data.aiMistakes.map((mistake, i) => i === data.aiMistakes.length - 1 ? `<span class="new-mistake">${mistake}</span>` : mistake).join('<br>');
                    howItWorks.innerHTML = howItWorks.innerHTML.split('<strong>Чему научился ИИ:</strong>')[0] + 
                        `<strong>Чему научился ИИ:</strong><br>${learnings || 'Пока нет данных'}<br><br>` +
                        `<strong>Ошибки ИИ:</strong><br>${mistakes || 'Пока нет данных'}`;
                })
                .catch(error => {
                    console.error('Ошибка получения данных:', error.message);
                    tbody.innerHTML = TIMEFRAMES.map(tf => `<tr><td colspan="${TIMEFRAMES.length + 1}">Ошибка загрузки данных: ${error.message}</td></tr>`).join('');
                    forecastAIDiv.innerHTML = `<h2>Прогноз ИИ:</h2> Ошибка загрузки: ${error.message}`;
                    aiLogDiv.innerHTML = `<h2>Лог ИИ:</h2><div class="block">Ошибка загрузки: ${error.message}</div>`;
                });
        }

        function resetStatsMain() {
            fetch('/reset-stats-main', { method: 'POST' })
                .then(() => updateData())
                .catch(error => console.error('Ошибка сброса статистики (main):', error));
        }

        function resetStatsTest() {
            fetch('/reset-stats-test', { method: 'POST' })
                .then(() => updateData())
                .catch(error => console.error('Ошибка сброса статистики (test):', error));
        }

        document.addEventListener('click', (e) => {
            const summary = e.target.closest('summary');
            if (summary) {
                const symbol = summary.textContent.trim();
                openDetails[symbol] = !openDetails[symbol];
            }
        });

        const TIMEFRAMES = ['5m', '15m', '30m', '1h', '4h', '1d', '1w'];
        updateData();
        setInterval(updateData, 10000);
    </script>
</body>
</html>
