<script>
    const tbody = document.getElementById('data');
    const tradeDiv = document.getElementById('trade');
    const reasoningDiv = document.getElementById('reasoning');
    const statsDiv = document.getElementById('stats');
    const recommendationsDiv = document.getElementById('recommendations');
    const marketMood = document.getElementById('marketMood');
    let lastSignal = {};

    function updateData() {
        fetch('/data')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                tbody.innerHTML = '';
                let recommendationsHtml = '<h2>Рекомендации ИИ:</h2><br>';
                const symbols = ['LDOUSDT', 'AVAXUSDT', 'XLMUSDT', 'HBARUSDT', 'BATUSDT', 'AAVEUSDT'];
                let totalLongs = 0;
                let totalShorts = 0;
                let totalRecommendations = 0;

                for (const symbol of symbols) {
                    const rec = data.recommendations[symbol] || {};
                    const trade = data.trades[symbol] || { active: null, openCount: 0, closedCount: 0, stopCount: 0, profitCount: 0, totalProfit: 0, totalLoss: 0 };
                    const row = document.createElement('tr');
                    recommendationsHtml += `<details open><summary>${symbol}</summary>`;
                    row.innerHTML = `
                        <td>${symbol}</td>
                        ${TIMEFRAMES.map(tf => {
                            const r = rec[tf] || { direction: 'Нет', confidence: 0, market: 'Флет', trend: 'none', pivot: lastPrices[symbol], reasoning: 'Нет данных', forecast: 'падение', outsideChannel: false, blinkDirection: '' };
                            const cls = r.direction === 'Лонг' ? 'long' : r.direction === 'Шорт' ? 'short' : 'neutral';
                            const marketCls = r.market === 'Флет' ? 'market-flat' : r.market === 'Восходящий' ? 'market-up' : 'market-down';
                            const trendArrow = r.trend === 'up' ? '↑' : r.trend === 'down' ? '↓' : '';
                            const blinkCls = r.outsideChannel ? `blink-${r.blinkDirection}` : '';
                            const signalKey = `${symbol}-${r.outsideChannel}`;
                            if (r.outsideChannel && lastSignal[signalKey] !== true && document.getElementById('channelExitCheckbox').checked) {
                                const audio = new Audio('https://freesound.org/data/previews/339/339810_5121236-lq.mp3'); // 5-секундный колокольчик
                                audio.play().catch(() => console.log(`Колокольчик для ${symbol} не воспроизведён`));
                                lastSignal[signalKey] = true;
                            } else if (!r.outsideChannel) {
                                lastSignal[signalKey] = false;
                            }
                            recommendationsHtml += `${tf}: прогноз: <span class="${r.forecast === 'рост' ? 'up' : 'down'}">${r.forecast}</span>, разворот: ${r.pivot.toFixed(4)} (${r.reasoning.split('.')[1] || 'нет данных'}), ${r.reasoning.split('.')[2] || ''}<br>`;
                            if (r.direction === 'Лонг') {
                                totalLongs += r.confidence;
                                totalRecommendations++;
                            } else if (r.direction === 'Шорт') {
                                totalShorts += r.confidence;
                                totalRecommendations++;
                            }
                            return `<td class="${cls} ${blinkCls}"><span class="${marketCls}" style="margin-right: 5px;"></span>${r.direction}${r.confidence > 0 ? ` ${r.confidence}%` : ''}<span class="${r.trend === 'up' ? 'up' : 'down'}" style="margin-left: 5px;">${trendArrow}</span></td>`;
                        }).join('')}
                    `;
                    recommendationsHtml += `</details>`;
                    tbody.appendChild(row);

                    if (trade.active) {
                        const cls = trade.active.direction === 'Лонг' ? 'long' : 'short';
                        tradeDiv.innerHTML = `<strong>Сделка:</strong> ${symbol} (${trade.active.timeframe}) <span class="${cls}">${trade.active.direction}</span> (${rec[trade.active.timeframe]?.confidence || 0}%), Открытие: ${trade.active.entry.toFixed(4)}, Стоп: ${trade.active.stopLoss.toFixed(4)}, Профит: ${trade.active.takeProfit.toFixed(4)}`;
                        reasoningDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> ${rec[trade.active.timeframe]?.reasoning || 'Нет данных'}`;
                    } else {
                        tradeDiv.innerHTML = '<strong>Сделка:</strong> Нет';
                        reasoningDiv.innerHTML = `<strong>Рассуждения ИИ:</strong> Нет активных сделок, рынок анализируется.`;
                    }
                    statsDiv.innerHTML = `<strong>Статистика:</strong> Открыто: ${trade.openCount}, Закрыто: ${trade.closedCount}, Стоп: ${trade.stopCount}, Профит: ${trade.profitCount}, Прибыль: ${trade.totalProfit.toFixed(2)} USDT, Убыток: ${trade.totalLoss.toFixed(2)} USDT <button onclick="resetStats()">Сбросить</button>`;
                }

                const longPercent = totalRecommendations > 0 ? Math.round(totalLongs / totalRecommendations) : 0;
                const shortPercent = totalRecommendations > 0 ? Math.round(totalShorts / totalRecommendations) : 0;
                marketMood.style.background = `linear-gradient(to right, green ${longPercent}%, red ${longPercent}%)`;
                marketMood.querySelector('.longs').textContent = `Лонги ${longPercent}%`;
                marketMood.querySelector('.shorts').textContent = `Шорты ${shortPercent}%`;

                recommendationsDiv.innerHTML = recommendationsHtml || '<h2>Рекомендации ИИ:</h2> Нет данных';
            })
            .catch(error => {
                console.error('Ошибка получения данных:', error.message, error.stack);
                tbody.innerHTML = TIMEFRAMES.map(tf => `<tr><td colspan="${TIMEFRAMES.length + 1}">Ошибка загрузки данных: ${error.message}</td></tr>`).join('');
                recommendationsDiv.innerHTML = `<h2>Рекомендации ИИ:</h2> Ошибка загрузки: ${error.message}`;
            });
    }

    function resetStats() {
        fetch('/reset-stats', { method: 'POST' })
            .then(() => updateData())
            .catch(error => console.error('Ошибка сброса статистики:', error));
    }

    const TIMEFRAMES = ['5m', '15m', '30m', '1h', '4h', '1d', '1w'];
    updateData();
    setInterval(updateData, 10000);
</script>
